# Data Model: Authentication Entities

**Feature**: 003-better-auth
**Date**: 2026-02-03
**Status**: Design

## Entity Overview

This authentication system introduces two primary entities managed by Better Auth: **User** and **Session**. Additionally, the JWT Token is a transient entity (not persisted in database, only in httpOnly cookies).

## Entity 1: User

### Description

Represents an authenticated individual in the todo application. Each user has unique credentials (email/password) and owns their personal collection of tasks. Better Auth automatically creates and manages this table.

### Fields

| Field Name | Type | Constraints | Description |
|------------|------|-------------|-------------|
| id | VARCHAR(255) | Primary Key, Auto-generated UUID | Unique identifier for the user |
| email | VARCHAR(255) | UNIQUE, NOT NULL | User's email address (used for login) |
| emailVerified | BOOLEAN | DEFAULT FALSE | Whether email has been verified (not used in this phase) |
| name | VARCHAR(255) | NULLABLE | User's display name (optional) |
| image | VARCHAR(255) | NULLABLE | Profile image URL (optional, not used) |
| createdAt | TIMESTAMP | NOT NULL, AUTO | Timestamp when user account was created |
| updatedAt | TIMESTAMP | NOT NULL, AUTO | Timestamp when user account was last updated |

### Relationships

- **One-to-Many with Tasks**: `User.id` → `Task.user_id` (ON DELETE CASCADE)
  - Each user owns multiple tasks
  - Deleting a user automatically deletes all their tasks
  - Enforces user data isolation

- **One-to-Many with Sessions**: `User.id` → `Session.userId` (ON DELETE CASCADE)
  - Each user can have multiple active sessions (different devices/browsers)
  - Deleting a user automatically invalidates all their sessions

- **One-to-Many with Accounts**: `User.id` → `Account.userId` (ON DELETE CASCADE)
  - Each user has one account record storing their password hash
  - Better Auth manages this relationship internally

### Validation Rules

- `email`: Must be valid email format, case-insensitive uniqueness
- `id`: Auto-generated UUID by Better Auth (format: `usr_xxxxxxxxxxxxxxxx`)
- `createdAt` / `updatedAt`: Auto-managed by database triggers
- All fields managed by Better Auth library (no manual validation needed)

### Indexes

1. **Primary Index**: `id` (auto-created by primary key)
2. **Email Unique Index**: `email` (for login lookups and uniqueness enforcement)
3. **No additional indexes needed** (Better Auth handles internally)

### State Transitions

- **Creation**: User signs up → `createdAt = now()`, `updatedAt = now()`, `emailVerified = false`
- **Update**: Profile changes → `updatedAt = now()`
- **Deletion**: Account deleted → Cascade deletes sessions, accounts, and tasks

---

## Entity 2: Session

### Description

Represents an active authenticated connection between a user and the application. Sessions are created on login/signup, stored in the database, and referenced by a JWT token in the user's httpOnly cookie. Better Auth automatically manages session lifecycle.

### Fields

| Field Name | Type | Constraints | Description |
|------------|------|-------------|-------------|
| id | VARCHAR(255) | Primary Key, Auto-generated UUID | Unique identifier for the session |
| userId | VARCHAR(255) | NOT NULL, Foreign Key → user.id | Links session to specific user |
| token | VARCHAR(255) | UNIQUE, NOT NULL | Session token (JWT string) |
| expiresAt | TIMESTAMP | NOT NULL | Timestamp when session expires (7 days from creation) |
| ipAddress | VARCHAR(255) | NULLABLE | IP address of the client (for security auditing) |
| userAgent | TEXT | NULLABLE | Browser user agent string (for device identification) |

### Relationships

- **Many-to-One with User**: `Session.userId` → `User.id` (ON DELETE CASCADE)
  - Multiple sessions can belong to one user
  - Deleting a user automatically invalidates all their sessions

### Validation Rules

- `token`: Unique JWT string, generated by Better Auth
- `expiresAt`: Must be in the future (7 days from creation)
- `userId`: Must reference an existing user
- `ipAddress` / `userAgent`: Optional metadata for security monitoring

### Indexes

1. **Primary Index**: `id` (auto-created by primary key)
2. **Token Unique Index**: `token` (for fast session lookups)
3. **User Index**: `userId` (for finding all sessions for a user)

### State Transitions

- **Creation**: User logs in → `expiresAt = now() + 7 days`, `token = generated JWT`
- **Validation**: Every API request → Check `expiresAt > now()`
- **Expiration**: `expiresAt` passes → Session invalid (user must log in again)
- **Logout**: User explicitly logs out → Session deleted from database

### Access Patterns

1. **Validate Session**: Query by `token` (from cookie), check `expiresAt > now()`
2. **List User Sessions**: Query by `userId` (for "devices logged in" feature - future)
3. **Create Session**: Insert with `userId`, `token`, `expiresAt = now() + 7 days`
4. **Delete Session**: Remove by `token` (logout) or `userId` (logout all devices)
5. **Cleanup Expired**: Periodic job to delete where `expiresAt < now()`

---

## Entity 3: JWT Token (Transient)

### Description

A cryptographically signed JSON Web Token containing user identity claims. **Not stored in database** - exists only in httpOnly cookies (client-side) and is validated on-the-fly by the backend. The token's payload is the source of truth for user_id during API requests.

### Structure (JSON Payload)

| Claim | Type | Description |
|-------|------|-------------|
| sub | STRING | Subject - User ID (extracted from User.id) |
| email | STRING | User's email address |
| iss | STRING | Issuer - "better-auth" (identifies token source) |
| aud | STRING | Audience - "fastapi-backend" (intended recipient) |
| exp | INTEGER | Expiration - Unix timestamp (7 days from issuance) |
| iat | INTEGER | Issued At - Unix timestamp (token creation time) |

### Validation Rules

- **Signature Verification**: Must be signed with BETTER_AUTH_SECRET (HS256 algorithm)
- **Expiration Check**: `exp` must be greater than current Unix timestamp
- **Issuer Check**: `iss` must equal "better-auth"
- **Audience Check**: `aud` must equal "fastapi-backend"
- **Subject Presence**: `sub` (user_id) must be present and non-empty

### Lifecycle

1. **Issuance**: Better Auth creates JWT on login/signup
2. **Storage**: Stored in httpOnly cookie (`better-auth.session_token`)
3. **Transmission**: Frontend proxy reads cookie (server-side), sends as `Authorization: Bearer <token>`
4. **Verification**: Backend verifies signature and claims using PyJWT
5. **Extraction**: Backend extracts `sub` claim as `user_id` for database queries
6. **Expiration**: After 7 days, JWT expires and user must log in again
7. **Revocation**: Logout clears cookie and deletes session from database

---

## Data Model Relationships Diagram

```
┌─────────────────────────────────────────┐
│              User                       │
│  ─────────────────────────────────────  │
│  id: VARCHAR(255) [PK]                  │
│  email: VARCHAR(255) [UNIQUE]           │
│  emailVerified: BOOLEAN                 │
│  name: VARCHAR(255)                     │
│  image: VARCHAR(255)                    │
│  createdAt: TIMESTAMP                   │
│  updatedAt: TIMESTAMP                   │
└──────┬───────────────────────┬──────────┘
       │                       │
       │ 1:N                   │ 1:N
       │ (owns)                │ (has)
       │                       │
       ▼                       ▼
┌─────────────────┐    ┌──────────────────────┐
│     Task        │    │      Session         │
│  ───────────    │    │  ──────────────────  │
│  id: SERIAL     │    │  id: VARCHAR(255)    │
│  user_id: FK ───┼────┤  userId: FK          │
│  title: VARCHAR │    │  token: VARCHAR      │
│  description    │    │  expiresAt: TIMESTAMP│
│  completed      │    │  ipAddress: VARCHAR  │
│  created_at     │    │  userAgent: TEXT     │
│  updated_at     │    └──────────────────────┘
└─────────────────┘
                          │
                          │ referenced by
                          ▼
                   ┌──────────────────┐
                   │   JWT Token      │
                   │   (in cookie)    │
                   │  ──────────────  │
                   │  sub: user_id    │
                   │  email: string   │
                   │  exp: timestamp  │
                   │  iat: timestamp  │
                   └──────────────────┘
```

---

## Integration with Existing Schema

### Task Entity Update

The existing Task entity (from `specs/002-db-schema/data-model.md`) needs a minor update to reference the User entity:

**Change**:
- `user_id` field type: `UUID/String` → `VARCHAR(255)` (to match Better Auth user.id format)

**SQL Migration**:

```sql
-- Alter tasks table to match Better Auth user.id type
ALTER TABLE tasks
  ALTER COLUMN user_id TYPE VARCHAR(255);

-- Ensure foreign key constraint exists
ALTER TABLE tasks
  ADD CONSTRAINT fk_tasks_user
  FOREIGN KEY (user_id)
  REFERENCES "user"(id)
  ON DELETE CASCADE;
```

**No other changes needed** - Task entity remains fully compatible with the authentication system.

---

## Better Auth Table Creation

Better Auth automatically creates all required tables when running migrations:

```bash
# From frontend directory
npx better-auth migrate
```

This creates:
1. `user` table (core entity)
2. `session` table (active sessions)
3. `account` table (password hashes - managed internally by Better Auth)
4. `verification` table (email verification tokens - not used in this phase)

**Manual Intervention Required**:
- Update existing `tasks` table to reference `user.id` (see SQL migration above)
- No other manual schema changes needed

---

**Data Model Complete** | Ready for API contract generation
