# JWT Authentication Flow

**Feature**: 001-project-foundation
**Date**: 2026-02-02
**Purpose**: Detailed JWT token lifecycle from creation to verification

## Overview

This document describes the complete JWT (JSON Web Token) authentication flow in the Phase II Todo Application, including token creation by Better Auth, storage in httpOnly cookies, transmission via Next.js API proxy, and verification by FastAPI backend.

## JWT Token Structure

### Token Format

```
Header.Payload.Signature
```

**Example JWT**:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMTIzIiwiZW1haWwiOiJ1c2VyQGV4YW1wbGUuY29tIiwiZXhwIjoxNzM4NTYwMDAwLCJpYXQiOjE3Mzc5NjAwMDB9.signature_here
```

### Decoded Components

**Header**:
```json
{
  "alg": "HS256",        // HMAC SHA-256 algorithm
  "typ": "JWT"           // Token type
}
```

**Payload (Claims)**:
```json
{
  "user_id": "123",                    // User identifier (primary key)
  "email": "user@example.com",         // User email
  "exp": 1738560000,                   // Expiration timestamp (7 days default)
  "iat": 1737960000                    // Issued at timestamp
}
```

**Signature**:
```
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  BETTER_AUTH_SECRET
)
```

**Critical**: Signature is computed using `BETTER_AUTH_SECRET`. This secret MUST be identical in frontend (Better Auth) and backend (JWT verification) to ensure tokens can be verified.

---

## Flow 1: User Registration

### Step-by-Step Process

```
┌─────────┐                ┌──────────────┐              ┌─────────────┐
│ Browser │                │   Frontend   │              │  Better Auth│
└────┬────┘                └──────┬───────┘              └──────┬──────┘
     │                             │                             │
     │ 1. Fill signup form         │                             │
     │────────────────────────────>│                             │
     │                             │                             │
     │                             │ 2. POST /api/auth/signup    │
     │                             │────────────────────────────>│
     │                             │    { email, password }      │
     │                             │                             │
     │                             │                             │ 3. Hash password
     │                             │                             │    Store in DB
     │                             │                             │
     │                             │                             │ 4. Generate JWT
     │                             │                             │    - user_id
     │                             │                             │    - email
     │                             │                             │    - exp (7 days)
     │                             │                             │    - Sign with SECRET
     │                             │                             │
     │                             │ 5. Response with JWT cookie │
     │                             │<────────────────────────────│
     │                             │    Set-Cookie: auth_token=<JWT>
     │                             │    HttpOnly; Secure; SameSite
     │                             │                             │
     │ 6. Redirect to dashboard    │                             │
     │<────────────────────────────│                             │
     │    (cookie auto-included)   │                             │
     │                             │                             │
```

**Key Points**:
- **Step 3**: Password is hashed (bcrypt/argon2) before storage - never plaintext
- **Step 4**: JWT generated by Better Auth JWT plugin using BETTER_AUTH_SECRET
- **Step 5**: Cookie flags:
  - `HttpOnly`: JavaScript cannot read (XSS protection)
  - `Secure`: Only sent over HTTPS in production
  - `SameSite=Lax`: CSRF protection
- **Step 6**: Cookie automatically included in subsequent requests to same origin

---

## Flow 2: User Login

### Step-by-Step Process

```
┌─────────┐                ┌──────────────┐              ┌─────────────┐
│ Browser │                │   Frontend   │              │  Better Auth│
└────┬────┘                └──────┬───────┘              └──────┬──────┘
     │                             │                             │
     │ 1. Submit credentials       │                             │
     │────────────────────────────>│                             │
     │                             │                             │
     │                             │ 2. POST /api/auth/signin    │
     │                             │────────────────────────────>│
     │                             │    { email, password }      │
     │                             │                             │
     │                             │                             │ 3. Verify credentials
     │                             │                             │    Compare hashed password
     │                             │                             │
     │                             │                             │ 4. Generate JWT
     │                             │                             │    (same as registration)
     │                             │                             │
     │                             │ 5. Response with JWT cookie │
     │                             │<────────────────────────────│
     │                             │    Set-Cookie: auth_token=<JWT>
     │                             │                             │
     │ 6. Redirect to dashboard    │                             │
     │<────────────────────────────│                             │
     │                             │                             │
```

**Security Notes**:
- **Step 3**: Timing-safe password comparison to prevent timing attacks
- **Invalid credentials**: Generic error message "Invalid email or password" (no user enumeration)
- **Rate limiting**: Prevent brute force attacks (e.g., 5 attempts per 15 minutes)

---

## Flow 3: Authenticated API Request (Fetch Tasks)

### Complete Request Cycle

```
┌─────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐    ┌──────────┐
│ Browser │    │  Next.js     │    │  API Proxy  │    │   Backend    │    │ Database │
│         │    │  Component   │    │  (proxy.ts) │    │   FastAPI    │    │   Neon   │
└────┬────┘    └──────┬───────┘    └──────┬──────┘    └──────┬───────┘    └─────┬────┘
     │                │                     │                  │                  │
     │ 1. Render      │                     │                  │                  │
     │   dashboard    │                     │                  │                  │
     │───────────────>│                     │                  │                  │
     │                │                     │                  │                  │
     │                │ 2. API client call  │                  │                  │
     │                │    GET /api/tasks   │                  │                  │
     │                │────────────────────>│                  │                  │
     │                │    (cookie included)│                  │                  │
     │                │                     │                  │                  │
     │                │                     │ 3. Read cookie   │                  │
     │                │                     │    Extract JWT   │                  │
     │                │                     │                  │                  │
     │                │                     │ 4. Forward request                  │
     │                │                     │    to backend    │                  │
     │                │                     │─────────────────>│                  │
     │                │                     │  Authorization:  │                  │
     │                │                     │  Bearer <JWT>    │                  │
     │                │                     │                  │                  │
     │                │                     │                  │ 5. JWT Middleware│
     │                │                     │                  │    - Extract JWT │
     │                │                     │                  │    - Verify sig  │
     │                │                     │                  │    - Decode      │
     │                │                     │                  │    - Attach user │
     │                │                     │                  │                  │
     │                │                     │                  │ 6. Route handler │
     │                │                     │                  │    user_id from  │
     │                │                     │                  │    request.state │
     │                │                     │                  │                  │
     │                │                     │                  │ 7. Query DB      │
     │                │                     │                  │─────────────────>│
     │                │                     │                  │  WHERE user_id   │
     │                │                     │                  │                  │
     │                │                     │                  │ 8. Return tasks  │
     │                │                     │                  │<─────────────────│
     │                │                     │                  │                  │
     │                │                     │ 9. JSON response │                  │
     │                │                     │<─────────────────│                  │
     │                │                     │                  │                  │
     │                │ 10. Forward to      │                  │                  │
     │                │     component       │                  │                  │
     │                │<────────────────────│                  │                  │
     │                │                     │                  │                  │
     │ 11. Render     │                     │                  │                  │
     │     tasks      │                     │                  │                  │
     │<───────────────│                     │                  │                  │
     │                │                     │                  │                  │
```

### Detailed Step Breakdown

**Step 1-2: Frontend initiates request**
- React component needs user's tasks
- API client makes fetch request to `/api/tasks`
- Browser automatically includes httpOnly cookie

**Step 3: API Proxy reads cookie** (Server-Side)
```typescript
// /app/api/proxy.ts
export async function GET(request: Request) {
  const cookies = request.headers.get('cookie')
  const jwt = extractJwtFromCookie(cookies, 'auth_token')

  if (!jwt) {
    return new Response('Unauthorized', { status: 401 })
  }

  // Continue to backend...
}
```

**Step 4: Proxy forwards to backend**
```typescript
const response = await fetch(`${BACKEND_URL}/api/${user_id}/tasks`, {
  headers: {
    'Authorization': `Bearer ${jwt}`,
    'Content-Type': 'application/json'
  }
})
```

**Step 5: Backend JWT Middleware verifies token**
```python
# middleware/jwt_auth.py
from jose import jwt, JWTError

async def verify_jwt(request: Request, call_next):
    auth_header = request.headers.get('Authorization')

    if not auth_header or not auth_header.startswith('Bearer '):
        raise HTTPException(status_code=401, detail="Missing authentication")

    token = auth_header.replace('Bearer ', '')

    try:
        # Verify signature and decode
        payload = jwt.decode(
            token,
            os.getenv('BETTER_AUTH_SECRET'),  # MUST match frontend
            algorithms=['HS256']
        )

        # Check expiration (automatic via jwt.decode)
        # Extract user info
        request.state.user = {
            'user_id': payload['user_id'],
            'email': payload['email']
        }

    except JWTError as e:
        raise HTTPException(status_code=401, detail="Invalid token")

    response = await call_next(request)
    return response
```

**Step 6: Route handler accesses user**
```python
# routes/tasks.py
@router.get("/api/{user_id}/tasks")
async def get_tasks(user_id: str, request: Request, db: Session = Depends(get_db)):
    # Verify URL user_id matches JWT user_id
    if user_id != request.state.user['user_id']:
        raise HTTPException(status_code=403, detail="Forbidden")

    # Query with user isolation
    tasks = db.query(Task).filter(Task.user_id == user_id).all()
    return {"data": tasks, "error": None}
```

**Step 7-10: Database query and response propagation**
- SQLModel executes parameterized query (SQL injection safe)
- Results returned through FastAPI → Proxy → Frontend
- JSON serialization at each boundary

---

## Flow 4: Token Expiration and Refresh

### Expiration Handling

```
┌─────────┐                ┌──────────────┐              ┌─────────────┐
│ Browser │                │   Frontend   │              │   Backend   │
└────┬────┘                └──────┬───────┘              └──────┬──────┘
     │                             │                             │
     │ 1. API request with         │                             │
     │    expired JWT              │                             │
     │────────────────────────────>│────────────────────────────>│
     │                             │                             │
     │                             │                             │ 2. JWT decode
     │                             │                             │    exp check fails
     │                             │                             │
     │                             │ 3. 401 Unauthorized         │
     │                             │<────────────────────────────│
     │                             │    "Token expired"          │
     │                             │                             │
     │ 4. Redirect to login        │                             │
     │<────────────────────────────│                             │
     │    Clear expired cookie     │                             │
     │                             │                             │
```

**Expiration Timeline**:
- Token issued at `iat` (issued at timestamp)
- Token expires at `exp` (expiration timestamp)
- Default: `exp = iat + 7 days`
- Backend rejects expired tokens immediately

**Future Enhancement**: Refresh token rotation
- Long-lived refresh token (30 days)
- Short-lived access token (15 minutes)
- Automatic refresh when access token expires
- Not implemented in foundation (out of scope)

---

## Flow 5: User Logout

```
┌─────────┐                ┌──────────────┐              ┌─────────────┐
│ Browser │                │   Frontend   │              │  Better Auth│
└────┬────┘                └──────┬───────┘              └──────┬──────┘
     │                             │                             │
     │ 1. Click logout             │                             │
     │────────────────────────────>│                             │
     │                             │                             │
     │                             │ 2. POST /api/auth/signout   │
     │                             │────────────────────────────>│
     │                             │                             │
     │                             │                             │ 3. Revoke session
     │                             │                             │    (if stored)
     │                             │                             │
     │                             │ 4. Clear cookie             │
     │                             │<────────────────────────────│
     │                             │    Set-Cookie: auth_token=;
     │                             │    Max-Age=0                │
     │                             │                             │
     │ 5. Redirect to login        │                             │
     │<────────────────────────────│                             │
     │    (no cookie)              │                             │
     │                             │                             │
```

**Security Notes**:
- Cookie cleared by setting `Max-Age=0`
- JWT itself cannot be "revoked" (stateless)
- If session stored server-side, mark as revoked
- User must obtain new JWT to authenticate again

---

## Security Considerations

### Threat 1: Token Theft

**Attack**: Attacker steals JWT token from browser

**Mitigations**:
- ✅ httpOnly cookies (JavaScript cannot access)
- ✅ Secure flag (HTTPS only in production)
- ✅ SameSite attribute (CSRF protection)
- ✅ Short expiration (7 days max)
- ⚠️ If stolen, attacker has access until expiration

### Threat 2: Man-in-the-Middle (MITM)

**Attack**: Attacker intercepts JWT during transmission

**Mitigations**:
- ✅ HTTPS/TLS encryption in production
- ✅ Certificate pinning (advanced, not in foundation)
- ⚠️ Development uses HTTP (local only, no external exposure)

### Threat 3: Signature Forgery

**Attack**: Attacker tries to forge JWT signature

**Mitigations**:
- ✅ HMAC SHA-256 signature algorithm
- ✅ BETTER_AUTH_SECRET kept secret (in .env, gitignored)
- ✅ Secret minimum 32 characters (high entropy)
- ✅ Backend verifies signature on every request

### Threat 4: Secret Mismatch

**Attack**: Frontend and backend use different secrets (configuration error)

**Mitigations**:
- ✅ Single root .env file (reduces duplication)
- ✅ Docker Compose passes same value to both services
- ✅ Documentation warns about matching requirement (2+ locations)
- ✅ Startup validation (optional enhancement)

### Threat 5: Token Replay

**Attack**: Attacker replays intercepted valid token

**Mitigations**:
- ✅ Token expiration (automatic timeout)
- ⚠️ No nonce or request-id tracking (stateless design)
- ⚠️ Attacker can use token until expiration if stolen

---

## Configuration Requirements

### Frontend (.env)

```bash
BETTER_AUTH_SECRET=your-secure-secret-here-min-32-chars
NEXT_PUBLIC_API_URL=http://localhost:8000
```

### Backend (.env)

```bash
BETTER_AUTH_SECRET=your-secure-secret-here-min-32-chars  # MUST MATCH FRONTEND
DATABASE_URL=postgresql://user:pass@host.neon.tech/db
CORS_ORIGINS=http://localhost:3000
```

### Docker Compose

```yaml
services:
  frontend:
    environment:
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}

  backend:
    environment:
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
```

**Critical**: All three configurations reference the same `BETTER_AUTH_SECRET` value from root `.env`.

---

## Validation Checklist

Before JWT authentication is considered complete:

- [ ] BETTER_AUTH_SECRET is identical in frontend and backend
- [ ] JWT tokens are stored in httpOnly cookies
- [ ] API proxy can read cookies server-side
- [ ] API proxy forwards JWT in Authorization header
- [ ] Backend middleware verifies JWT signature
- [ ] Backend middleware decodes user_id and email
- [ ] Backend attaches user to request.state
- [ ] Route handlers validate user_id match
- [ ] Expired tokens are rejected with 401
- [ ] Invalid signatures are rejected with 401
- [ ] User isolation enforced on all queries
- [ ] Logout clears cookie properly

---

## Testing Scenarios

### Test 1: Valid JWT

```bash
# Expected: 200 OK, user's tasks returned
curl -H "Authorization: Bearer <valid_jwt>" \
  http://localhost:8000/api/123/tasks
```

### Test 2: Expired JWT

```bash
# Expected: 401 Unauthorized, "Token expired"
curl -H "Authorization: Bearer <expired_jwt>" \
  http://localhost:8000/api/123/tasks
```

### Test 3: Invalid Signature

```bash
# Expected: 401 Unauthorized, "Invalid token"
curl -H "Authorization: Bearer <forged_jwt>" \
  http://localhost:8000/api/123/tasks
```

### Test 4: Missing Authorization Header

```bash
# Expected: 401 Unauthorized, "Missing authentication"
curl http://localhost:8000/api/123/tasks
```

### Test 5: User ID Mismatch

```bash
# JWT has user_id=123, URL has user_id=456
# Expected: 403 Forbidden
curl -H "Authorization: Bearer <user_123_jwt>" \
  http://localhost:8000/api/456/tasks
```

---

## Implementation Files

**Frontend**:
- `/app/api/proxy.ts` - API proxy reading httpOnly cookies
- `/lib/auth.ts` - Better Auth configuration
- `/lib/api-client.ts` - API client using proxy

**Backend**:
- `middleware/jwt_auth.py` - JWT verification middleware
- `main.py` - Middleware registration
- `routes/*.py` - Route handlers accessing request.state.user

**Configuration**:
- `.env` - Shared secret and connection strings
- `docker-compose.yml` - Environment variable passing
